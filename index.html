<!DOCTYPE html>
<html>
  <head>
    <title>react-native-webrtc server</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  </head>
  <body>
    <div id="textRoom" style="display: none;">
      <div id="textRoomContent">
        <h3>Text Room</h3>
      </div>
      <input id="textRoomInput" >
      <button onclick="textRoomPress();">Send</button>
    </div>
    <video id="selfView" autoplay></video>
    <div id="remoteViewContainer"></div>
    <div id="roomIDContainer">
      <input id="roomID" value="abc">
      <button onclick="press();">Join/Create room</button>
    </div>
  </body>
  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript">
    var     socket = io("https://50.67.201.214:4443");

    var RTCPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection || window.msRTCPeerConnection;
    var RTCSessionDescription = window.RTCSessionDescription || window.mozRTCSessionDescription || window.webkitRTCSessionDescription || window.msRTCSessionDescription;
    navigator.getUserMedia = navigator.getUserMedia || navigator.mozGetUserMedia || navigator.webkitGetUserMedia || navigator.msGetUserMedia;

    var twilioIceServers = [
      { url: 'stun:global.stun.twilio.com:3478?transport=udp' }
      // { url: 'turn:global.turn.twilio.com:3478?transport=udp',
      //   username: 'ea757ad2c42b932c7f2abe480295e7eb039dc2b13b78c86bc412818ed51e5eea',
      //   credential: 'MPnnojPRoPDI+B3kLONGF9P440Lb8NkrTq+FxxJBVro=' },
      // { url: 'turn:global.turn.twilio.com:3478?transport=tcp',
      //   username: 'ea757ad2c42b932c7f2abe480295e7eb039dc2b13b78c86bc412818ed51e5eea',
      //   credential: 'MPnnojPRoPDI+B3kLONGF9P440Lb8NkrTq+FxxJBVro=' },
      // { url: 'turn:global.turn.twilio.com:443?transport=tcp',
      //   username: 'ea757ad2c42b932c7f2abe480295e7eb039dc2b13b78c86bc412818ed51e5eea',
      //   credential: 'MPnnojPRoPDI+B3kLONGF9P440Lb8NkrTq+FxxJBVro=' }
    ];
    var configuration = {"iceServers": [{"url": "stun:stun.l.google.com:19302"}]};
    // configuration.iceServers = twilioIceServers;

    var pcPeers = {};
    var selfView = document.getElementById("selfView");
    var remoteViewContainer = document.getElementById("remoteViewContainer");
    var localStream;

    function getLocalStream() {
      navigator.getUserMedia({ "audio": true, "video": true }, function (stream) {
        localStream = stream;
        console.log("SETTING LOCAL VIDEO CHANNEL VIEW")

        selfView.src = URL.createObjectURL(stream);
        selfView.muted = true;
      }, logError);
    }

    function join(roomID) {
      socket.emit('join', roomID, function(socketIds){
        console.log('Handshake:: join', JSON.stringify(socketIds));
        for (var i in socketIds) {
          var socketId = socketIds[i];
          createPC(socketId, true);
        }
      });
    }

    function createPC(socketId, isOffer) {
      console.log("RTCChannel::CreateListener: id:"+socketId+"  offer:"+isOffer)
      var pc = new RTCPeerConnection(configuration);
      pcPeers[socketId] = pc;

      pc.onicecandidate = function (event) {
        console.log('RTCChannel:: on ice candidate', event)
        if (event.candidate) {
          socket.emit('exchange', {'to': socketId, 'candidate': event.candidate });
        }
      };

      pc.onnegotiationneeded = function () {
        console.log('RTCChannel:: on ice candidate', event)
        if (isOffer) {
          createOffer();
        }
        else {
          console.log("no offer.")
        }
      }

      pc.oniceconnectionstatechange = function(event) {
        console.log('RTCChannel:: on ice connection state change', event)
        if (event.target.iceConnectionState === 'connected') {
          createDataChannel();
        }
      };
      pc.onsignalingstatechange = function(event) {
        console.log('RTCChannel:: onsignalingstatechange', event)
      };

      pc.onaddstream = function (event) {
        console.log('onaddstream', event);
        console.log("ADDING VIDEO CHANNEL VIEW")
        var element = document.createElement('video');
        element.id = "remoteView" + socketId;
        element.autoplay = 'autoplay';
        element.src = URL.createObjectURL(event.stream);
        remoteViewContainer.appendChild(element);
      };
      console.log("RTC Channel:: Add stream:"+JSON.stringify(localStream))
      pc.addStream(localStream);


      function createOffer() {
        console.log('is Offer!!!')
        pc.createOffer(function(desc) {
          console.log('createOffer', desc);
          pc.setLocalDescription(desc, function () {
            console.log('RTCChannel:: in negotiation: setLocalDescription', pc.localDescription)
            socket.emit('exchange', {'to': socketId, 'sdp': pc.localDescription });
          }, logError);
        }, logError);
      }

      function createDataChannel() {
        console.log("ADDING TEXT CHANNEL")
        if (pc.textDataChannel) {
          return;
        }
        var dataChannel = pc.createDataChannel("text");

        dataChannel.onerror = function (error) {
          console.log("dataChannel.onerror", error);
        };

        dataChannel.onmessage = function (event) {
          console.log("dataChannel.onmessage:", event.data);
          var content = document.getElementById('textRoomContent');
          content.innerHTML = content.innerHTML + '<p>' + socketId + ': ' + event.data + '</p>';
        };

        dataChannel.onopen = function () {
          console.log('dataChannel.onopen');
          var textRoom = document.getElementById('textRoom');
          textRoom.style.display = "block";
        };

        dataChannel.onclose = function () {
          console.log("dataChannel.onclose");
        };

        pc.textDataChannel = dataChannel;
      }
      return pc;
    }

    function exchange(data) {
      console.log("RTCChannel::"+data.from+" exchange:"+data.sdp)
      var fromId = data.from;
      var pc;
      if (fromId in pcPeers) {
        console.log("found peer"+fromId)
        pc = pcPeers[fromId];
      } else {
        console.log("createPC from exchange!!!!!!!!!!"+fromId)
        pc = createPC(fromId, false);
      }

      if (data.sdp) {
        console.log('RTCChannel:: exchange description', data)
        pc.setRemoteDescription(new RTCSessionDescription(data.sdp), function () {
          if (pc.remoteDescription.type == "offer")
            pc.createAnswer(function(desc) {
              console.log('RTCChannel:: createAnswer', desc)
              pc.setLocalDescription(desc, function () {
                console.log('RTCChannel:: setLocalDescription', pc.localDescription)
                socket.emit('exchange', {'to': fromId, 'sdp': pc.localDescription });
              }, function (error) {
                callback("RTCChannel:: ERROR in set local descriptoin:"+error, null)
              });
            }, function (error) {
              callback("RTCChannel:: ERROR in create answer:"+error, null)
            });
        }, function (error) {
          callback("RTCChannel:: ERROR in set remote description: "+error, null)
        });
      } else {
        console.log('exchange candidate', data);
        pc.addIceCandidate(new RTCIceCandidate(data.candidate));
      }
    }

    function leave(socketId) {
      console.log('leave', socketId);
      var pc = pcPeers[socketId];
      pc.close();
      delete pcPeers[socketId];
      console.log("REMOVING VIDEO CHANNEL VIEW")

      var video = document.getElementById("remoteView" + socketId);
      if (video) video.remove();
    }

    socket.on('exchange', function(data){
      exchange(data);
    });
    socket.on('leave', function(socketId){
      leave(socketId);
    });

    socket.on('connect', function(data) {
      console.log('connect');
      getLocalStream();
    });

    function logError(error) {
      console.log("logError", error);
    }

    function press() {
      var roomID = document.getElementById('roomID').value;
      if (roomID == "") {
        alert('Please enter room ID');
      } else {
        var roomIDContainer = document.getElementById('roomIDContainer');
        roomIDContainer.parentElement.removeChild(roomIDContainer);
        join(roomID);
      }
    }
    function textRoomPress() {
      var text = document.getElementById('textRoomInput').value;
      if (text == "") {
        alert('Enter something');
      } else {
        document.getElementById('textRoomInput').value = '';
        var content = document.getElementById('textRoomContent');
        content.innerHTML = content.innerHTML + '<p>' + 'Me' + ': ' + text + '</p>';
        for (var key in pcPeers) {
          var pc = pcPeers[key];
          pc.textDataChannel.send(text);
        }
      }
    }

  </script>

</html>
