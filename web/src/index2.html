<!DOCTYPE html>
<html>
    <head>
        <title>react-native-webrtc server</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    </head>
    <body>
        <div id="textRoom" style="display: none;">
            <div id="textRoomContent">
                <h3>Text Room</h3>
            </div>
            <input id="textRoomInput" >
            <button onclick="textRoomPress();">Send</button>
        </div>
        <video id="selfView" autoplay></video>
        <div id="remoteViewContainer"></div>
        <div id="roomIDContainer">
            <input id="roomID" value="abc">
            <button onclick="press();">Join/Create room</button>
        </div>
    </body>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script type="text/javascript">
        var selfView = document.getElementById("selfView");
        var remoteViewContainer = document.getElementById("remoteViewContainer");

        var socket = io("https://50.67.201.214:4443");
        var RTCPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection || window.msRTCPeerConnection;
        var RTCSessionDescription = window.RTCSessionDescription || window.mozRTCSessionDescription || window.webkitRTCSessionDescription || window.msRTCSessionDescription;
        navigator.getUserMedia = navigator.getUserMedia || navigator.mozGetUserMedia || navigator.webkitGetUserMedia || navigator.msGetUserMedia;

        var configuration = {"iceServers": [{"url": "stun:stun.l.google.com:19302"}]};

        var pcPeers = {};

        var localStream;

        function getLocalStream() {
            navigator.getUserMedia({ "audio": true, "video": true }, function (stream) {
                localStream = stream;
                console.log("SETTING LOCAL VIDEO CHANNEL VIEW")

                selfView.src = URL.createObjectURL(stream);
                selfView.muted = true;
            }, logError);
        }

        function join(roomID) {
            socket.emit('join', roomID, function(socketIds){
                console.log('Handshake:: join', JSON.stringify(socketIds));
                for (var i in socketIds) {
                    var socketId = socketIds[i];
                    createPC(socketId, true);
                }
            });
        }

        function createPC(socketId, isOffer) {
            console.log("RTCChannel::CreateListener: id:"+socketId+"  offer:"+isOffer)
            var pc = new RTCPeerConnection(configuration);
            pcPeers[socketId] = pc;

            pc.onicecandidate = function (event) {
                console.log('RTCChannel:: on ice candidate', event)
                if (event.candidate) {
                    socket.emit('exchange', {'to': socketId, 'candidate': event.candidate });
                }
            };

            pc.onnegotiationneeded = function () {
                console.log('RTCChannel:: on ice candidate', event)
                if (isOffer) {
                    createOffer();
                }
            }

            pc.oniceconnectionstatechange = function(event) {
                console.log('RTCChannel:: on ice connection state change', event)
                if (event.target.iceConnectionState === 'connected') {
                    createDataChannel();
                }
            };
            pc.onsignalingstatechange = function(event) {
                console.log('RTCChannel:: onsignalingstatechange', event)
            };

            pc.onaddstream = function (event) {
                console.log('onaddstream', event);
                console.log("ADDING VIDEO CHANNEL VIEW")
                var element = document.createElement('video');
                element.id = "remoteView" + socketId;
                element.autoplay = 'autoplay';
                element.src = URL.createObjectURL(event.stream);
                remoteViewContainer.appendChild(element);
            };
            console.log("RTC Channel:: Add stream:"+JSON.stringify(localStream))
            pc.addStream(localStream);


            function createOffer() {
                console.log('is Offer!!!')
                pc.createOffer(function(desc) {
                    console.log('createOffer', desc);
                    pc.setLocalDescription(desc, function () {
                        console.log('RTCChannel:: in negotiation: setLocalDescription', pc.localDescription)
                        socket.emit('exchange', {'to': socketId, 'sdp': pc.localDescription });
                    }, logError);
                }, logError);
            }

            function createDataChannel() {
                console.log("ADDING TEXT CHANNEL")
                if (pc.textDataChannel) {
                    return;
                }
                var dataChannel = pc.createDataChannel("text");

                dataChannel.onerror = function (error) {
                    console.log("dataChannel.onerror", error);
                };

                dataChannel.onmessage = function (event) {
                    console.log("dataChannel.onmessage:", event.data);
                    var content = document.getElementById('textRoomContent');
                    content.innerHTML = content.innerHTML + '<p>' + socketId + ': ' + event.data + '</p>';
                };

                dataChannel.onopen = function () {
                    console.log('dataChannel.onopen');
                    var textRoom = document.getElementById('textRoom');
                    textRoom.style.display = "block";
                };

                dataChannel.onclose = function () {
                    console.log("dataChannel.onclose");
                };

                pc.textDataChannel = dataChannel;
            }
            return pc;
        }

        function exchange(data) {
            var fromId = data.from;
            var pc;
            if (fromId in pcPeers) {
                pc = pcPeers[fromId];
            } else {
                pc = createPC(fromId, false);
            }

            if (data.sdp) {
                console.log('RTCChannel:: exchange description', data)
                pc.setRemoteDescription(new RTCSessionDescription(data.sdp), function () {
                    if (pc.remoteDescription.type == "offer")
                        pc.createAnswer(function(desc) {
                            console.log('RTCChannel:: createAnswer', desc)
                            pc.setLocalDescription(desc, function () {
                                console.log('RTCChannel:: setLocalDescription', pc.localDescription)
                                socket.emit('exchange', {'to': fromId, 'sdp': pc.localDescription });
                            }, function (error) {
                                callback("RTCChannel:: ERROR in set local descriptoin:"+error, null)
                                return
                            });
                        }, function (error) {
                            callback("RTCChannel:: ERROR in create answer:"+error, null)
                            return
                        });
                }, function (error) {
                    callback("RTCChannel:: ERROR in set remote description: "+error, null)
                    return
                });
            } else {
                console.log('exchange candidate', data);
                pc.addIceCandidate(new RTCIceCandidate(data.candidate));
            }
        }

        function leave(socketId) {
            console.log('leave', socketId);
            var pc = pcPeers[socketId];
            pc.close();
            delete pcPeers[socketId];
            console.log("REMOVING VIDEO CHANNEL VIEW")

            var video = document.getElementById("remoteView" + socketId);
            if (video) video.remove();
        }

        socket.on('exchange', function(data){
            exchange(data);
        });
        socket.on('leave', function(socketId){
            leave(socketId);
        });

        socket.on('connect', function(data) {
            console.log('connect');
            getLocalStream();
        });

        function logError(error) {
            console.log("logError", error);
        }

        function press() {
            var roomID = document.getElementById('roomID').value;
            if (roomID == "") {
                alert('Please enter room ID');
            } else {
                var roomIDContainer = document.getElementById('roomIDContainer');
                roomIDContainer.parentElement.removeChild(roomIDContainer);
                join(roomID);
            }
        }
        function textRoomPress() {
            var text = document.getElementById('textRoomInput').value;
            if (text == "") {
                alert('Enter something');
            } else {
                document.getElementById('textRoomInput').value = '';
                var content = document.getElementById('textRoomContent');
                content.innerHTML = content.innerHTML + '<p>' + 'Me' + ': ' + text + '</p>';
                for (var key in pcPeers) {
                    var pc = pcPeers[key];
                    pc.textDataChannel.send(text);
                }
            }
        }

    </script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-68314333-1', 'auto');
        ga('send', 'pageview');

    </script>
</html>
