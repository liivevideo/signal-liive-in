// Generated by CoffeeScript 1.10.0
(function() {
  var RTCChannel;

  RTCChannel = (function() {
    var RTCPeerConnection, RTCSessionDescription, _createListener, configuration, createOffer, createTextChannel, getUserMedia, localStream, observers, pcPeers, reactions;

    pcPeers = {};

    localStream = null;

    getUserMedia = null;

    configuration = null;

    observers = null;

    reactions = null;

    RTCPeerConnection = null;

    RTCSessionDescription = null;

    function RTCChannel(_configuration, _observers, _reactions) {
      configuration = _configuration;
      RTCPeerConnection = _configuration.RTCPeerConnection;
      RTCSessionDescription = _configuration.RTCSessionDescription;
      getUserMedia = configuration.getUserMedia;
      observers = _observers;
      reactions = _reactions;
    }

    RTCChannel.prototype.getMedia = function(types, callback) {
      console.log("Get Media!!!!");
      getUserMedia(types, function(stream) {
        localStream = stream;
        console.log("setting local stream:" + JSON.stringify(stream));
        observers.foundLocalVideoChannel(localStream);
        callback(stream);
      }, function(error) {
        return console.log(error);
      });
    };

    createTextChannel = function(pc, socketId) {
      var dataChannel;
      console.log('RTCChannel:: create Text Channel', event);
      if ((pc.textDataChannel != null)) {
        return;
      }
      dataChannel = pc.createDataChannel("text");
      pc.textDataChannel = observers.addedTextChannel(socketId, dataChannel);
    };

    RTCChannel.prototype.createListener = function(socketId, isOffer) {
      return _createListener(socketId, isOffer);
    };

    createOffer = function(pc, socketId) {
      console.log('is Offer!!!');
      return pc.createOffer(function(desc) {
        console.log('createOffer', desc);
        return pc.setLocalDescription(desc, function() {
          console.log('RTCChannel::id:' + socketId + ' in negotiation: setLocalDescription', pc.localDescription);
          return reactions.exchangeDescription(socketId, pc.localDescription);
        }, function(error) {
          return console.log("ERROR::onnegotiationneeded: set local description error:" + error);
        });
      }, function(error) {
        return console.log("ERROR::onnegotiationneeded: Create Offer error:" + error);
      });
    };

    _createListener = function(socketId, isOffer) {
      var pc;
      console.log("RTCChannel::CreateListener: id:" + socketId + "  offer:" + isOffer);
      pc = new RTCPeerConnection(configuration);
      pcPeers[socketId] = pc;
      pc.onicecandidate = function(event) {
        if ((event != null) && (event.candidate != null)) {
          console.log('RTCChannel:: id:' + socketId + ' on ice candidate ' + event.candidate);
          return reactions.exchangeCandidate(socketId, event.candidate);
        } else {
          return console.log('RTCChannel:: id:' + socketId + ' on ice candidate, not a candidate');
        }
      };
      pc.onnegotiationneeded = function() {
        if (isOffer) {
          console.log('RTCChannel::id:' + socketId + ' on negotiation needed:' + event);
          return createOffer(pc, socketId);
        } else {
          return console.log('RTCChannel::id:' + socketId + ' on negotiation needed: no offer.');
        }
      };
      pc.oniceconnectionstatechange = function(event) {
        console.log('RTCChannel:: id:' + socketId + ' on ice connection state change', event);
        if (event.target.iceConnectionState === 'connected') {
          return createTextChannel(pc, socketId);
        }
      };
      pc.onsignalingstatechange = function(event) {
        return console.log('RTCChannel:: onsignalingstatechange', event);
      };
      pc.onaddstream = function(event) {
        console.log('RTCChannel::id:' + socketId + ' on add stream...');
        return observers.addedVideoChannel(socketId, event.stream);
      };
      console.log("RTC Channel:: Add stream:" + JSON.stringify(localStream));
      pc.addStream(localStream);
      return pc;
    };

    RTCChannel.prototype.deleteListener = function(socketId, callback) {
      var pc;
      console.log('RTCChannel:: id: ' + socketId + ' delete listener ...');
      pc = pcPeers[socketId];
      if (pc) {
        pc.close();
        delete pcPeers[socketId];
      }
      observers.removedVideoChannel(socketId);
      callback(null, socketId);
    };

    RTCChannel.prototype.send = function(text) {
      var key, pc;
      console.log("RTCChannel:: send:" + text);
      for (key in pcPeers) {
        pc = pcPeers[key];
        pc.textDataChannel.send(text);
      }
    };

    RTCChannel.prototype.exchange = function(data) {
      var fromId, pc2;
      console.log("RTCChannel::" + data.from + " exchange:" + data.sdp);
      fromId = data.from;
      if ((pcPeers[fromId] != null)) {
        console.log("FOUND PEER___________:" + fromId);
        pc2 = pcPeers[fromId];
      } else {
        console.log("createPC from exchange!!!!!!!!!!" + fromId);
        pc2 = _createListener(fromId, false);
      }
      if (data.sdp) {
        console.log('RTCChannel:: exchange description', JSON.stringify(data));
        pc2.setRemoteDescription(new RTCSessionDescription(data.sdp), function() {
          if (pc2.remoteDescription.type === "offer") {
            pc2.createAnswer(function(desc) {
              console.log('RTCChannel:: createAnswer', desc);
              return pc2.setLocalDescription(desc, function() {
                console.log('RTCChannel:: setLocalDescription', pc2.localDescription);
                return reactions.exchangeDescription(fromId, pc2.localDescription);
              }, function(error) {
                console.log("RTCChannel:: ERROR in set local descriptoin:" + error, null);
              });
            }, function(error) {
              console.log("RTCChannel:: ERROR in create answer:" + error, null);
            });
          }
        }, function(error) {
          console.log("RTCChannel:: ERROR in set remote description: " + error, null);
        });
      } else {
        console.log('RTCChannel:: new ice candidate', data);
        pc2.addIceCandidate(new RTCIceCandidate(data.candidate));
      }
    };

    return RTCChannel;

  })();

  if ((typeof module !== "undefined" && module !== null) && (module.exports != null)) {
    module.exports = RTCChannel;
  }

  if ((typeof window !== "undefined" && window !== null)) {
    window.RTCChannel = RTCChannel;
  }

}).call(this);

//# sourceMappingURL=RTCChannel.js.map
